<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • User Management</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css" />
  <style>
    body { padding: 20px; }
    .container { max-width: 960px; }
    .card + .card { margin-top: 16px; }
    .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .topbar .left { display: flex; gap: 8px; align-items: center; }
    .topbar .right { display: flex; gap: 8px; align-items: center; }
  </style>
  <script>
    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      } catch {}
      window.location.href = '/login?redirect=%2F';
    }

    async function getMe() {
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (!res.ok) return null;
        const json = await res.json();
        return json?.data || null;
      } catch { return null; }
    }

    async function fetchUsers(page=0, limit=20, search='') {
      const params = new URLSearchParams({ page, limit, search });
      const res = await fetch(`/api/auth/users?${params.toString()}`, { credentials: 'include' });
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Failed to fetch users');
      return json.data;
    }

    async function createUser(e) {
      e.preventDefault();
      const form = e.target;
      const payload = {
        username: form.username.value.trim(),
        password: form.password.value,
        email: form.email.value.trim() || undefined,
        display_name: form.display_name.value.trim() || undefined,
        role: form.role.value
      };
      const res = await fetch('/api/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.success) return alert(json.error || 'Failed to create user');
      alert('User created');
      form.reset();
      load();
    }

    async function resetPassword(user_uuid) {
      const new_password = prompt('Enter new password (min 6 chars)');
      if (!new_password || new_password.length < 6) return;
      const res = await fetch(`/api/auth/users/${user_uuid}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ new_password })
      });
      const json = await res.json();
      if (!json.success) return alert(json.error || 'Failed to reset password');
      alert('Password reset');
    }

    async function load() {
      try {
        const search = document.getElementById('search').value.trim();
        const { users } = await fetchUsers(0, 50, search);
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.username}</td>
            <td>${u.display_name || ''}</td>
            <td>${u.email || ''}</td>
            <td>${u.role}</td>
            <td>${u.is_active ? 'active' : 'inactive'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="resetPassword('${u.user_uuid}')">Reset Password</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        alert('Failed to load users');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Populate topbar with current user and role
      const me = await getMe();
      const userInfo = document.getElementById('user-info');
      if (me) {
        userInfo.textContent = `${me.display_name || me.username} • ${me.role}`;
      }
      document.getElementById('create-form').addEventListener('submit', createUser);
      document.getElementById('search').addEventListener('input', () => {
        clearTimeout(window._searchTimer);
        window._searchTimer = setTimeout(load, 400);
      });
      load();
    });
  </script>
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="left">
          <a class="btn btn-outline-secondary" href="/">← Back to Library</a>
        </div>
        <div class="right">
          <span id="user-info" class="text-muted"></span>
          <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>
      </div>
      <h1>Admin • User Management</h1>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Create User</h5>
          <form id="create-form">
            <div class="row g-2">
              <div class="col"><input class="form-control" name="username" placeholder="Username" required minlength="3" /></div>
              <div class="col"><input class="form-control" name="password" placeholder="Password" required minlength="6" type="password" /></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col"><input class="form-control" name="display_name" placeholder="Display Name" /></div>
              <div class="col"><input class="form-control" name="email" placeholder="Email" type="email" /></div>
              <div class="col">
                <select class="form-select" name="role">
                  <option value="user">user</option>
                  <option value="admin">admin</option>
                </select>
              </div>
              <div class="col"><button class="btn btn-primary w-100" type="submit">Create</button></div>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Users</h5>
          <input id="search" class="form-control" placeholder="Search by username/display name/email" />
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>Username</th>
                <th>Display Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
  </html>
